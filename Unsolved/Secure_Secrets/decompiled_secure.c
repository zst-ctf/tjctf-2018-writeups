//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
// Copyright (c) 2018 Retargetable Decompiler <info@retdec.com>
//

#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// ------------------------ Structures ------------------------

struct _IO_FILE {
    int32_t e0;
};

// ------------------- Function Prototypes --------------------

int32_t get_message(int32_t a1, int32_t a2);
int32_t lets_be_friends(int32_t a1);
int32_t set_message(int32_t a1, char * a2);

// --------------------- Global Variables ---------------------

int32_t g1 = 0; // esp
int32_t g2 = 10;
int32_t g3 = 0;
struct _IO_FILE * g4 = NULL;

// ------------------------ Functions -------------------------

// Address range: 0x80486db - 0x8048713
int32_t lets_be_friends(int32_t a1) {
    int32_t v1 = getegid(); // 0x80486e1
    setresgid(v1, v1, v1);
    setbuf(g4, NULL);
    int32_t * v2;
    return (int32_t)&v2;
}

// Address range: 0x8048793 - 0x8048857
int32_t set_message(int32_t a1, char * a2) {
    // 0x8048793
    puts("How does this work?");
    char * str = "First, choose a strong password to protect your message:"; // bp-28
    puts("First, choose a strong password to protect your message:");
    int32_t v1; // bp-12
    *(int32_t *)((int32_t)&v1 - 16) = (int32_t)"> ";
    int32_t * format;
    printf((char *)&format);
    *(int32_t *)(g1 + 8) = g3;
    *(int32_t *)(g1 + 4) = 16;
    *(int32_t *)g1 = (int32_t)a2;
    int32_t size;
    fgets(str, size, (struct _IO_FILE *)&format);
    // branch -> 0x80487b9
    while (*a2 == 10) {
        // 0x80487b9
        *(int32_t *)g1 = (int32_t)"> ";
        printf((char *)&format);
        *(int32_t *)(g1 + 8) = g3;
        *(int32_t *)(g1 + 4) = 16;
        *(int32_t *)g1 = (int32_t)a2;
        fgets(str, size, (struct _IO_FILE *)&format);
        // continue -> 0x80487b9
    }
    // 0x80487eb
    *(int32_t *)g1 = (int32_t)"Good choice! Now, simply leave your message below:";
    puts(str);
    *(int32_t *)g1 = (int32_t)"> ";
    printf((char *)&format);
    *(int32_t *)(g1 + 8) = 64;
    *(int32_t *)(g1 + 4) = 0;
    *(int32_t *)g1 = a1;
    memset((int32_t *)str, size, (int32_t)&format);
    *(int32_t *)(g1 + 8) = g3;
    *(int32_t *)(g1 + 4) = 64;
    *(int32_t *)g1 = a1;
    fgets(str, size, (struct _IO_FILE *)&format);
    *(int32_t *)g1 = (int32_t)"All done!";
    puts(str);
    *(int32_t *)g1 = (int32_t)"You can rest easy knowing that we are 100% unhackable.\n";
    return puts(str);
}

// Address range: 0x8048857 - 0x8048929
int32_t get_message(int32_t a1, int32_t a2) {
    // 0x8048857
    puts("For proof of concept, try accessing your message below.");
    char * str = "You must input the correct password:"; // bp-76
    puts("You must input the correct password:");
    int32_t v1; // bp-32
    int32_t v2 = &v1; // 0x80488b6
    int32_t v3; // bp-60
    *(int32_t *)((int32_t)&v3 - 16) = (int32_t)"> ";
    int32_t * format;
    printf((char *)&format);
    *(int32_t *)(g1 + 8) = g3;
    *(int32_t *)(g1 + 4) = 16;
    *(int32_t *)g1 = v2;
    char * size;
    fgets(str, (int32_t)size, (struct _IO_FILE *)&format);
    *(int32_t *)(g1 + 4) = v2;
    *(int32_t *)g1 = a2;
    // branch -> 0x804889b
    while (strcmp(str, size) != 0) {
        // 0x804889b
        *(int32_t *)g1 = (int32_t)"> ";
        printf((char *)&format);
        *(int32_t *)(g1 + 8) = g3;
        *(int32_t *)(g1 + 4) = 16;
        *(int32_t *)g1 = v2;
        fgets(str, (int32_t)size, (struct _IO_FILE *)&format);
        *(int32_t *)(g1 + 4) = v2;
        *(int32_t *)g1 = a2;
        // continue -> 0x804889b
    }
    // 0x80488da
    *(int32_t *)g1 = (int32_t)&g2;
    printf((char *)&format);
    *(int32_t *)g1 = a1;
    printf((char *)&format);
    *(int32_t *)g1 = (int32_t)&g2;
    printf((char *)&format);
    *(int32_t *)g1 = (int32_t)"Tada! Hope you liked our service!";
    puts(str);
    int32_t result; // 0x8048928
    if (*(int32_t *)20 != *(int32_t *)20) {
        // 0x8048922
        __stack_chk_fail();
        result = (int32_t)&format;
        // branch -> 0x8048927
    } else {
        result = 0;
    }
    // 0x8048927
    return result;
}

// Address range: 0x8048929 - 0x80489a2
int main(int argc, char ** argv) {
    // 0x8048929
    lets_be_friends((int32_t)argv);
    puts("Introducing Secure Secrets TM -- a revolutionary service for storing your most sensitive messages.");
    puts("NEW FEATURE COMING SOON: Safely store your darkest secrets as well!\n");
    int32_t v1; // bp-84
    int32_t v2 = &v1; // 0x8048979
    int32_t v3 = 0; // bp-100
    set_message(v2, (char *)&v3);
    get_message(v2, (int32_t)&v3);
    exit(0);
    int32_t * v4;
    return (int32_t)&v4;
}

// --------------- Dynamically Linked Functions ---------------

// void __stack_chk_fail(void);
// void exit(int status);
// char * fgets(char * restrict s, int n, FILE * restrict stream);
// __gid_t getegid(void);
// void * memset(void * s, int c, size_t n);
// int printf(const char * restrict format, ...);
// int puts(const char * s);
// void setbuf(FILE * restrict stream, char * restrict buf);
// int setresgid(__gid_t rgid, __gid_t egid, __gid_t sgid);
// int strcmp(const char * s1, const char * s2);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: gcc (5.4.0)
// Detected functions: 4
// Decompilation date: 2018-08-11 09:51:10
